!function(){function r(t){var e=$("#customerAlrim");if(e.children(".card, span").remove(),e.hasClass("ps")||e.data("scroll",new PerfectScrollbar("#customerAlrim",{suppressScrollX:!0})),t&&0!==t.length){var o="";t.forEach(function(t,a){o+='<div class="card shadow-sm"><button class="card-header btn btn-sm text-left" id="customerAlrimCardHeader'+a+'" type="button" data-toggle="collapse" data-target="#customerAlrimCardBody'+a+'" aria-expanded="false" aria-controls="customerAlrimCardBody'+a+'" title="눌러서 전송된 알림톡 내용 보기">'+moment(t.date,"YYYYMMDDHHmm").format("YYYY년 M월 D일 HH시 mm분")+'</button><div id="customerAlrimCardBody'+a+'" class="collapse" aria-labelledby="customerAlrimCardHeader'+a+'" parent="#customerAlrimList"><div class="card-body">'+(t.contents||"(내용 없음)")+"</div></div></div>",0<a&&a%50==0&&(e.append(o).data("scroll").update(),o="")}),e.append(o)}else e.append("<span class='text-center'>이 고객에게 전송된 알림톡 내역이 없습니다!<br/>"+("Y"!==NMNS.info.alrimTalkInfo.useYn?"알림톡을 사용하도록 설정하고 ":"")+"새로운 예약을 등록하여 알림톡을 보내보세요.</span>");e.data("scroll").update()}function a(t){var a=NMNS.customerList[Number(t.parent().data("index"))];a.id?NMNS.socket.emit("get customer alrim",{id:a.id}):r([]),$("#customerName").val(a.name),$("#customerContact").val(a.contact),$("#customerEtc").val(a.etc);var e="";e=0===a.totalNoShow?"이 고객은 노쇼하신 적이 없으시네요! :)":0===a.myNoShow?"이 고객은 다른 매장에서 "+a.totalNoShow+"번 노쇼하셨어요.":a.myNoShow===a.totalNoShow?"이 고객은 우리 매장에서만 "+a.totalNoShow+"번 노쇼하셨어요.":"이 고객은 우리 매장에서 "+a.myNoShow+"번, 전체 매장에서 "+a.totalNoShow+"번 노쇼하셨어요.",$("#customerNoShow").text(e),function(t){var e=$("#customerHistory");if(e.children(".card, span").remove(),e.hasClass("ps")||e.data("scroll",new PerfectScrollbar(e[0])),t.history&&0!==t.history.length){var o="";t.history.forEach(function(t,a){switch(o+='<div class="card col-12 col-lg-10 shadow-sm" data-index="'+a+'"><div class="card-body"><h6 class="mb-1">'+(t.contents&&""!==t.contents?t.contents:"(예약내용 없음)")+" ",t.status){case"CANCELED":o+="<small class='badge badge-light'>취소</small>";break;case"NOSHOW":o+="<small class='badge badge-danger'>노쇼</small>";break;case"CUSTOMERCANCELED":o+="<small class='badge badge-light'>고객취소</small>";break;case"RESERVED":o+="<small class='badge badge-success'>정상</small>"}o+=(moment(t.date,"YYYYMMDDHHmm").isValid()?'<small class="text-muted d-none d-lg-inline-block float-right">'+moment(t.date,"YYYYMMDDHHmm").format("YYYY-MM-DD HH:mm")+"</small>":"")+'</h6><div class="col-12 px-0">'+(moment(t.date,"YYYYMMDDHHmm").isValid()?'<span class="card-subtitle d-lg-none text-muted">'+moment(t.date,"YYYYMMDDHHmm").format("YYYY-MM-DD HH:mm")+"</span>":"")+(t.managerName&&""!==t.managerName?'<span class="tui-full-calendar-icon tui-full-calendar-calendar-dot" style="background-color:'+t.managerColor+'"></span><span> '+t.managerName+"</span>":"(담당자 없음)")+'</div></div><div class="cardLeftBorder" style="background-color:'+(t.managerColor||"#b2dfdb")+'"></div></div></div>',0<a&&a%50==0&&(e.append(o).data("scroll").update(),o="")}),e.append(o)}else e.append("<span class='text-center'>아직 이 고객에 등록된 예약내역이 없습니다.</span>");e.data("scroll").update()}(a);var o=NMNS.calendar.getCalendars().find(function(t){return t.id===a.managerId});$("#customerManager").html("<span class='tui-full-calendar-icon tui-full-calendar-calendar-dot' style='background-color: "+(o?o.borderColor:"#b2dfdb")+"'></span><span class='tui-full-calendar-content'>"+(o?o.name:"(담당자 없음)")+"</span>").data("calendar-id",o?o.id:"").data("bgcolor",o?o.borderColor:"#b2dfdb"),$("#customerModal").data("customer",a)}function n(){var o=$("#mainCustomerList");o.children(".card").remove(),o.hasClass("ps")||o.data("scroll",new PerfectScrollbar(o[0],{suppressScrollX:!0}));var r="";if(NMNS.customerList&&0<NMNS.customerList.length){var s=NMNS.calendar.getCalendars();NMNS.customerList.forEach(function(a,t){var e=s.find(function(t){return t.id===a.managerId});r+='<div class="card row shadow-sm" data-index="'+t+'"><div class="card-body"><h5 class="card-title mb-sm-1'+(a.history&&0<a.history.length?"":" longTitle")+'">'+(a.name&&""!==a.name?a.name:"(이름없음)")+(a.contact&&""!==a.contact?'&nbsp;<small class="card-subtitle text-muted d-none d-sm-inline-block">'+dashContact(a.contact)+"</small>":"")+"</h5>"+(a.contact&&""!==a.contact?'<a href="tel:'+a.contact+'" class="d-inline-block d-sm-none customerContactLink"><span class="card-subtitle text-muted"><i class="fas fa-phone fa-rotate-90"></i> '+dashContact(a.contact)+"</span></a>":"")+(a.history&&0<a.history.length?'<div><small class="d-sm-none">총 '+a.history.length+"회 방문 | 마지막 방문 "+moment(a.history[0].date,"YYYYMMDDHHmm").format("YYYY-MM-DD")+"</small></div>":"")+'<div class="col-12 row px-0 mx-0"><div class="col-4 pl-0 border-right"><small class="text-muted">담당자</small><br/><span class="tui-full-calendar-icon tui-full-calendar-calendar-dot" style="background-color:'+(e?e.borderColor:"#b2dfdb")+'"></span><span> '+(e?e.name:"(담당자 없음)")+'</span></div><div class="col-8 pr-0"><small class="text-muted">메모</small><br/><span>'+(a.etc||"")+'</span></div></div></div><div class="cardLeftBorder" style="background-color:'+(e?e.borderColor:"#b2dfdb")+'"></div><small class="customerSubInfo text-muted">'+(a.history&&0<a.history.length?'<span class="d-none d-sm-inline-block">총 '+a.history.length+"회 방문 | 마지막 방문 "+moment(a.history[0].date,"YYYYMMDDHHmm").format("YYYY-MM-DD")+" |&nbsp;</span>":"")+'<a class="deleteCustomerLink text-muted" href="#" title="삭제"><i class="fas fa-times"></i> 삭제</a></small><a class="w-100 h-100 position-absolute customerModalLink" href="#" data-toggle="modal" data-target="#customerModal" title="상세보기"></a></div></div>',0<t&&t%50==0&&(o.append(r),r="")}),o.append(r),o.data("scroll").update(),o.find(".customerModalLink").off("touch click").on("touch click",function(t){t.preventDefault(),a($(this))}),o.find(".deleteCustomerLink").off("touch click").on("touch click",function(t){if(t.preventDefault(),confirm("정말 이 고객을 삭제하시겠어요?")){var a=Number($(this).parentsUntil(void 0,".card").data("index"));if(Number.isInteger(a)){var e=NMNS.customerList[a];e&&(NMNS.history.push($.extend({index:a},e)),NMNS.socket.emit("delete customer",{id:e.id}),NMNS.customerList.remove(e.id,function(t,a){return t.id===a}),n())}}}),$("#customerCount").text(NMNS.customerList.length)}}function e(t){NMNS.socket.emit("get customer list",{type:"all",target:t})}$(".addHistory").on("touch click",function(t){$($("#sidebarContainer .calendarMenuLink")[0]).trigger("click"),$("#customerModal").data("trigger",!0).modal("hide")}),NMNS.socket.on("get customer list",socketResponse("고객 조회",function(t){if(NMNS.customerList=t.data,t.data&&0<t.data.length){var e=NMNS.calendar.getCalendars();t.data.forEach(function(a){a.manager=e[e.findIndex(function(t){return t.id===a.managerId})]})}n()})),NMNS.socket.on("add customer",socketResponse("고객 추가",function(a){var t=NMNS.customerList.findIndex(function(t){return t.id===a.data.id});t&&-1<t&&(NMNS.customerList[t].totalNoShow=a.data.totalNoShow||0,NMNS.customerList[t].myNoShow=0),$("#customerAddName").val(""),$("#customerAddContact").val(""),$("#customerAddEtc").val("")},function(a){var t=NMNS.customerList.findIndex(function(t){return t.id===a.data.id});t&&-1<t&&(NMNS.customerList.splice(t,1),n())})),NMNS.socket.on("update customer",socketResponse("고객정보 수정",function(a){var t=NMNS.customerList.findIndex(function(t){return t.id===a.data.id});if(t&&-1<t){var e=NMNS.customerList[t];e.name=$("#customerName").val(),e.contact=$("#customerContact").val(),e.etc=$("#customerEtc").val(),e.managerId=$("#customerManager").data("calendar-id");var o=NMNS.calendar.getCalendars();e.manager=o[o.findIndex(function(t){return t.id===e.managerId})],showSnackBar("<span>고객의 정보를 수정하였습니다.</span>"),n()}},function(a){if("DUPLICATED"===a.data.reason){if(confirm("이미 같은 이름과 연락처를 가진 고객이 존재합니다.\n그 고객쪽으로 모든 정보 및 예약, 알림톡 내역을 합칠까요?"))return void NMNS.socket.emit("merge customer",{id:a.data.id,name:$("#customerName").val(),contact:$("#customerContact").val(),etc:$("#customerEtc").val(),managerId:$("#customerManager").data("calendar-id")})}else alert("고객정보 수정에 실패하였습니다."+(a.message?"("+a.message+")":""));var t=NMNS.customerList.findIndex(function(t){return t.id===a.data.id});t&&-1<t&&($("#customerName").val(NMNS.customerList[t].name),$("#customerContact").val(NMNS.customerList[t].contact),$("#customerEtc").val(NMNS.customerList[t].etc))},!0)),NMNS.socket.on("get customer alrim",socketResponse("알림톡 내역 조회",function(t){r(t.data)})),NMNS.socket.on("delete customer",socketResponse("고객 삭제",function(t){NMNS.history.remove(t.data.id,function(t,a){return t.id===a})},function(a){var t=NMNS.history.find(function(t){return t.id===a.data.id});NMNS.history.remove(a.data.id,function(t,a){return t.id===a}),NMNS.customerList.splice(t.index,0,t),n()})),NMNS.socket.on("merge customer",socketResponse("고객정보 합치기",function(){NMNS.socket.emit("get customer list",{type:"all",target:""===$("#customerSearchTarget").val()?void 0:$("#customerSearchTarget").val(),sort:$($(".customerSortType.active")[0]).data("action")}),showSnackBar("<span>두 고객의 정보와 예약, 알림톡 내역을 합쳤습니다.</span>"),$("#customerModal").modal("hide")},function(){NMNS.socket.emit("get customer list",{type:"all",target:""===$("#customerSearchTarget").val()?void 0:$("#customerSearchTarget").val(),sort:$($(".customerSortType.active")[0]).data("action")}),$("#customerModal").modal("hide")})),$("#customerModal").on("hidden.bs.modal",function(){if($(this).data("trigger")){$(this).removeData("trigger");var t=$(this).data("customer"),a=moment(new Date);a.hour()>=Number(NMNS.info.bizEndTime.substring(0,2))||a.hour()+1==Number(NMNS.info.bizEndTime.substring(0,2))&&a.minute()+30>Number(NMNS.info.bizEndTime.substring(2))?a=moment(NMNS.info.bizEndTime,"HHmm").subtract(30,"m"):a.hour()<Number(NMNS.info.bizBeginTime.substring(0,2))||a.hour()==Number(NMNS.info.bizBeginTime.substring(0,2))&&a.minute()<Number(NMNS.info.bizBeginTime.substring(2))?a=moment(NMNS.info.bizBeginTime,"HHmm"):a.minute(10*Math.ceil(a.minute()/10)),NMNS.calendar.openCreationPopup({title:t.name,start:a.toDate(),end:a.add(30,"m").toDate(),raw:{contact:t.contact,etc:t.etc},calendarId:t.managerId?t.managerId:void 0})}}).on("shown.bs.modal",function(){$("#customerName").focus()}),$("#customerContact, #customerAddContact").off("blur").on("blur",function(){filterNonNumericCharacter($(this))}),$("#submitCustomerAdd").on("touch click",function(t){if(t.preventDefault(),""!==$("#customerAddName").val()||""!==$("#customerAddContact").val()){var a={id:generateRandom(),name:$("#customerAddName").val(),contact:$("#customerAddContact").val(),etc:$("#customerAddEtc").val(),managerId:$("#customerAddManager").data("calendar-id")};NMNS.socket.emit("add customer",a),NMNS.customerList.splice(0,0,a),n()}else alert("고객 이름과 전화번호 중 하나는 반드시 입력해주세요.")}),$("#submitCustomer").on("touch click",function(t){t.preventDefault();var a=$("#customerModal").data("customer");if(a){if(""===$("#customerName").val()&&""===$("#customerContact").val())return void alert("고객 이름과 전화번호 중 하나는 반드시 입력해주세요.");NMNS.socket.emit("update customer",{id:a.id,name:$("#customerName").val(),contact:$("#customerContact").val(),etc:$("#customerEtc").val(),managerId:$("#customerManager").data("calendar-id")})}else alert("알 수 없는 오류입니다. 새로고침 후 다시 시도해주세요.")}),$(".customerSortType").off("touch click").on("touch click",function(t){if(!$(this).hasClass("active")){var a,e=t.target.getAttribute("data-action");e||(e=t.target.parentElement.getAttribute("data-action")),NMNS.customerList.sort(function e(t){switch(t){case"sort-date":return function(t,a){return t.history&&0!==t.history.length?a.history&&0!==a.history.length?t.history[0].date<a.history[0].date?1:t.history[0].date>a.history[0].date?-1:e("sort-name")(t,a):-1:a.history&&0<a.history.length?1:e("sort-name")(t,a)};case"sort-manager":return function(t,a){return t.manager?a.manager?t.manager.name<a.manager.name?-1:t.manager.name>a.manager.name?1:e("sort-name")(t,a):-1:a.manager?1:e("sort-name")(t,a)};case"sort-name":default:return function(t,a){return t.name?a.name?t.name<a.name?-1:t.name>a.name?1:0:-1:a.name?1:0}}}(e)),n(),a=e,$(".customerSortType").removeClass("active"),$(".customerSortType[data-action='"+a+"']").addClass("active"),$("#customerSort span").text($("#customerSort").next().children("[data-action='"+a+"']").attr("aria-label"))}}),$("#customerSearchBtn").on("touch click",function(t){t.preventDefault(),e($("#customerSearchTarget").val())}),$("#customerSearchTarget").on("keyup",function(t){13===t.which&&e($(this).val())}),$(".addCustomerLink").on("touch click",function(t){t.preventDefault(),$("#mainCustomer").is(":visible")||$($("#sidebarContainer .customerMenuLink")[0]).trigger("click");var a=$("#customerAddName");a.focus();var e=$("#customerAddNameIcon"),o=6,r=setInterval(function(){0<o?(a.toggleClass("blink"),e.toggleClass("blink"),o--):clearInterval(r)},150)})}();