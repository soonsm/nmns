!function(){function o(t){var a=$("#customerAlrim");if(a.children(".card, span").remove(),a.hasClass("ps")||a.data("scroll",new PerfectScrollbar("#customerAlrim",{suppressScrollX:!0})),t&&0!==t.length){var s="";t.forEach(function(t,e){s+='<div class="card shadow-sm"><button class="card-header btn btn-sm text-left" id="customerAlrimCardHeader'+e+'" type="button" data-toggle="collapse" data-target="#customerAlrimCardBody'+e+'" aria-expanded="false" aria-controls="customerAlrimCardBody'+e+'" title="눌러서 전송된 알림톡 내용 보기">'+moment(t.date,"YYYYMMDDHHmm").format("YYYY년 M월 D일 HH시 mm분")+'</button><div id="customerAlrimCardBody'+e+'" class="collapse" aria-labelledby="customerAlrimCardHeader'+e+'" parent="#customerAlrimList"><div class="card-body">'+(t.contents||"(내용 없음)")+"</div></div></div>",0<e&&e%50==0&&(a.append(s).data("scroll").update(),s="")}),a.append(s)}else a.append("<span class='text-center'>이 고객에게 전송된 알림톡 내역이 없습니다!<br/>"+("Y"!==NMNS.info.alrimTalkInfo.useYn?"알림톡을 사용하도록 설정하고 ":"")+"새로운 예약을 등록하여 알림톡을 보내보세요.</span>");a.data("scroll").update()}function r(t){var e=NMNS.customerList[Number(t.parent().data("index"))];e.id?NMNS.socket.emit("get customer alrim",{id:e.id}):o([]),$("#customerName").val(e.name),$("#customerContact").val(e.contact),$("#customerEtc").val(e.etc);var a="";a=0===e.totalNoShow?"이 고객은 노쇼하신 적이 없으시네요! :)":0===e.myNoShow?"이 고객은 다른 매장에서 "+e.totalNoShow+"번 노쇼하셨어요.":e.myNoShow===e.totalNoShow?"이 고객은 우리 매장에서만 "+e.totalNoShow+"번 노쇼하셨어요.":"이 고객은 우리 매장에서 "+e.myNoShow+"번, 전체 매장에서 "+e.totalNoShow+"번 노쇼하셨어요.",$("#customerNoShow").text(a),function(t){var a=$("#customerHistory");if(a.children(".card, span").remove(),a.hasClass("ps")||a.data("scroll",new PerfectScrollbar(a[0])),t.history&&0!==t.history.length){var s="";t.history.forEach(function(t,e){switch(s+='<div class="card col-12 col-lg-10 shadow-sm" data-index="'+e+'"><div class="card-body"><h6 class="mb-1">'+(t.contents&&""!==t.contents?t.contents:"(예약내용 없음)")+" ",t.status){case"CANCELED":s+="<small class='badge badge-light'>취소</small>";break;case"NOSHOW":s+="<small class='badge badge-danger'>노쇼</small>";break;case"CUSTOMERCANCELED":s+="<small class='badge badge-light'>고객취소</small>";break;case"RESERVED":s+="<small class='badge badge-success'>정상</small>"}s+=(moment(t.date,"YYYYMMDDHHmm").isValid()?'<small class="text-muted d-none d-lg-inline-block float-right">'+moment(t.date,"YYYYMMDDHHmm").format("YYYY-MM-DD HH:mm")+"</small>":"")+'</h6><div class="col-12 px-0">'+(moment(t.date,"YYYYMMDDHHmm").isValid()?'<span class="card-subtitle d-lg-none text-muted">'+moment(t.date,"YYYYMMDDHHmm").format("YYYY-MM-DD HH:mm")+"</span>":"")+(t.managerName&&""!==t.managerName?'<span class="tui-full-calendar-icon tui-full-calendar-calendar-dot" style="background-color:'+t.managerColor+'"></span><span> '+t.managerName+"</span>":"(담당자 없음)")+'</div></div><div class="cardLeftBorder" style="background-color:'+(t.managerColor||"#b2dfdb")+'"></div></div></div>',0<e&&e%50==0&&(a.append(s).data("scroll").update(),s="")}),a.append(s)}else a.append("<span class='text-center'>아직 이 고객에 등록된 예약내역이 없습니다.</span>");a.data("scroll").update()}(e);var s=NMNS.calendar.getCalendars().find(function(t){return t.id===e.managerId});$("#customerManager").html("<span class='tui-full-calendar-icon tui-full-calendar-calendar-dot' style='background-color: "+(s?s.borderColor:"#b2dfdb")+"'></span><span class='tui-full-calendar-content'>"+(s?s.name:"(담당자 없음)")+"</span>").data("calendar-id",s?s.id:"").data("bgcolor",s?s.borderColor:"#b2dfdb"),$("#customerModal").data("customer",e)}$("#mainRow").append('<div id="customerModal" class="modal fade" tabIndex="-1" role="dialog" aria-label="고객 정보" aria-hidden="true">        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">          <div class="modal-content">            <div class="modal-header p-0 mx-0">              <div class="row mx-0 col-12" style="padding:25px 30px 0 30px;border-bottom:1px solid rgba(58, 54, 54, 0.35)">                <ul id="customerTabList" class="nav nav-pills" role="tabList" style="display:inline-flex !important;height:47px;">                  <li class="nav-item" style="display:inline-flex !important"><a class="nav-link pt-0 rounded-0 active" href="#customerInfo" data-toggle="tab" aria-selected="true" aria-label="고객 정보">고객 정보</a></li>                  <li class="nav-item" style="display:inline-flex !important"><a class="nav-link pt-0 rounded-0" href="#customerSchedule" data-toggle="tab" aria-label="예약 내역">예약 내역</a></li>                  <li class="nav-item" style="display:inline-flex !important"><a class="nav-link pt-0 rounded-0" href="#customerAlrim" data-toggle="tab" aria-label="알림톡 내역">알림톡 내역</a></li>                  <li class="nav-item" style="display:inline-flex !important"><a class="nav-link pt-0 rounded-0" href="#customerMembership" data-toggle="tab" aria-label="멤버십 금액 내역">멤버십 금액 내역</a></li>                </ul>                <button type="button" class="close p-0 ml-auto mr-0 my-0" data-dismiss="modal" aria-label="닫기">                  <span aria-hidden="true" style="vertical-align:text-top;line-height:0px">&times;</span>                </button>              </div>            </div>            <div class="modal-body">              <div class="row mx-0 col-12 tab-content p-0">                                      <div id="customerInfo" class="tab-pane col-12 px-0 fade show active" role="tabpanel">                  <div class="row mx-0">                    <div id="customerNoShow">총 <span id="customerNoShowCount">0</span>건의 노쇼 이력이 있는 고객님이에요.</div>                    <div>고객 이름</div>                    <input type="text" class="form-control form-control-sm mt-3" id="customerName" placeholder="고객 이름을 입력해주세요." style="margin-bottom:35px">                    <div>고객 연락처</div>                    <input type="text" pattern="[0-9]*" class="form-control form-control-sm mt-3" id="customerName" placeholder="고객 연락처를 입력해주세요." style="margin-bottom:35px">                    <div class="col-6 px-0">담당자</div><div class="col-6 px-0">고객메모</div>                  </div>                  <div class="d-flex">                    <div class="col mr-1">                      <button id="customerManager" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="btn btn-sm dropdown-toggle btn-flat form-control form-control-sm text-left" aria-label="담당자">                        <span>선택</span>                      </button>                      <div class="dropdown-menu" aria-labelledby="customerManager" role="menu" id="salesSearchManagerList" style="right:0"></div></div>                    <div class="col ml-1"></div>                  </div>                  <div class="d-flex updatingCustomer">                    <div class="customerTitle">멤버십 잔액</div>                    <div class="ml-auto"><span id="customerBalanceMembership">0</span>원</div>                  </div>                  <div class="d-flex updatingCustomer">                    <div class="customerTitle">총 매출액</div>                    <div class="ml-auto"><span id="customerTotalSales">0</span>원</div>                  </div>                  <div class="d-flex">                    <button type="button" class="btn btn-white col mr-1 addCustomerScheduleBtn">예약 추가</button>                    <button id="customerBtn" type="button" class="btn btn-accent col ml-1">저장</button>                  </div>                </div>                                <div id="customerSchedule" class="tab-pane col-12 px-0 fade" role="tabpanel">                  <div id="customerScheduleNotEmpty" class="row mx-0">                    <div class="row mx-0 col-12 px-0 customerScheduleHead">                      <div class="col-5 justify-center customerScheduleSortType active" data-action="sort-date">날짜</div><div class="col-1 justify-center customerScheduleSortType" data-action="sort-manager">담당</div>                      <div class="col-4 px-0">예약내용</div><div class="col-1 px-0 customerScheduleSortType" data-action="sort-sales">매출액</div><div class="col-1 px-0 customerScheduleSortType" data-action="sort-status">예약상태</div>                    </div>                    <div class="row" id="customerScheduleList"></div>                    <div class="d-flex">                      <button type="button" class="btn btn-white col mr-1 addCustomerScheduleBtn">예약 추가</button>                      <button type="button" dismiss="modal" class="btn btn-accent col ml-1">닫기</button>                    </div>                  </div>                  <div id="customerScheduleEmpty" style="display:none">예약 내역이 없어요.</div>                </div>                                <div id="customerAlrim" class="tab-pane col-12 px-0 fade" role="tabpanel">                  <div class="d-flex">                    <div id="customerAlrimList" class="row"></div>                  </div>                </div>                                <div id="customerMembership" class="tab-pane col-12 px-0 fade" role="tabpanel">                  <div class="d-flex">                    <div>멤버십 추가 적립</div>                    <div class="row mx-0 col-12 px-0"><input type="text" pattern="[0-9]*" id="customerMembershipSales" class="form-control form-control-sm han col" aria-label="멤버십 추가 적립" placeholder="금액을 숫자로 입력하세요." >                    <button type="button" class="btn btn-sm btn-form ml-2 addCustomerMembership">추가</button></div>                  </div>                  <div class="d-flex">                    <div>멤버십 금액 조절</div>                    <div class="row mx-0 col-12 px-0"><input type="text" id="customerMembershipAdjust" class="form-control form-control-sm han col" aria-label="멤버십 금액 조절" placeholder="+/- 숫자를 입력하면 멤버십 금액을 임의로 조절할 수 있어요." >                    <button type="button" class="btn btn-sm btn-form ml-2 addCustomerMembershipAdjust">추가</button></div>                  </div>                  <div class="row mx-0 col-12 px-0 customerMembershipHead">                    <div class="col-3 justify-center">날짜</div><div class="col-4 justify-center">내용</div><div class="col-5 px-0"><div class="col-6 justify-center">증/감</div><div class="col-6 justify-center">잔액</div></div>                  </div>                  <div class="row" id="customerMembershipList"></div>                </div>                              </div>            </div>          </div>        </div>      </div>');var i=0;function n(t,e){for(var a,s,o=NMNS.calendar.getCalendars(),r="",i=t;i<e;i++)s=NMNS.customerList[i],(a=o.find(function(t){return t.id===s.managerId}))||(a={color:"#334150",name:"(삭제된 담당자)"}),r+='<div class="customer col-12" data-index="'+i+'"><div><span class="tui-full-calendar-weekday-schedule-bullet" style="background:'+a.color+'" title="'+a.name+'"></span></div><div class="col col-1 px-0 font-weight-bold" style="font-size:14px">'+(s.name&&""!==s.name?s.name:"(이름없음)")+'</div><div class="col col-2 montserrat">'+(s.contact&&""!==s.contact?dashContact(s.contact):"")+'</div><div class="col col-1" style="font-size:10px">'+(s.history?s.history.length+"회":"0회")+'</div><div class="col-4"><div class="col col-4 px-0 montserrat">'+(s.history&&0<s.history.length?moment(s.history[0].date,"YYYYMMDDHHmm").format("YYYY. MM. DD"):"-")+'</div><div class="col col-4 px-0 montserrat">'+(0!=s.sales&&s.sales?(s.sales+"").replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1,"):"-")+'</div><div class="col col-4 px-0 montserrat">'+(0!=s.membership&&s.membership?(s.membership+"").replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1,"):"-")+'</div></div><div class="col" style="font-size:10px">'+(s.etc||"-")+'</div><a class="customerModalLink" href="#" data-toggle="modal" data-target="#customerModal" title="상세보기"></a></div>';return r}function c(t){var e,a=$("#mainCustomerList"),s="";NMNS.customerList&&t?(a.children(":not(.ps)").remove(),NMNS.customerList&&0<NMNS.customerList.length?s+=n(0,e=Math.min(0===i?i+Math.max(20,5+Math.ceil($("#mainCustomerList").height()/48)-$("#mainCustomerList .customer").length):i,NMNS.customerList.length)):s+="<p>아직 등록된 고객이 없습니다. 새로운 고객을 등록하여 방문 및 매출내역을 기록, 관리해보세요!</p>"):NMNS.customerList&&(e=Math.min(i+Math.max(20,5+Math.ceil($("#mainCustomerList").height()/48)-$("#mainCustomerList .customer").length),NMNS.customerList.length),s+=n(i,e)),i=e,$("#customerCount").text(NMNS.customerList.length),a.append(s),a.find(".customerModalLink").off("touch click").on("touch click",function(t){t.preventDefault(),r($(this))}),a.find(".deleteCustomerLink").off("touch click").on("touch click",function(t){if(t.preventDefault(),confirm("정말 이 고객을 삭제하시겠어요?")){var e=Number($(this).parentsUntil(void 0,".card").data("index"));if(Number.isInteger(e)){var a=NMNS.customerList[e];a&&(NMNS.history.push($.extend({index:e},a)),NMNS.socket.emit("delete customer",{id:a.id}),NMNS.customerList.remove(a.id,function(t,e){return t.id===e}),c(!0))}}})}$(".addHistory").on("touch click",function(t){$($("#sidebarContainer .calendarMenuLink")[0]).trigger("click"),$("#customerModal").data("trigger",!0).modal("hide")}),NMNS.socket.on("get customer list",socketResponse("고객 조회",function(t){if(NMNS.customerList=t.data,t.data&&0<t.data.length){var a=NMNS.calendar.getCalendars();t.data.forEach(function(e){e.manager=a[a.findIndex(function(t){return t.id===e.managerId})]})}c(!(i=0))})),NMNS.socket.on("add customer",socketResponse("고객 추가",function(e){var t=NMNS.customerList.findIndex(function(t){return t.id===e.data.id});Number.isInteger(t)&&-1<t&&(NMNS.customerList[t].totalNoShow=e.data.totalNoShow||0,NMNS.customerList[t].myNoShow=0),$("#customerAddName").val(""),$("#customerAddContact").val(""),$("#customerAddEtc").val("")},function(e){var t=NMNS.customerList.findIndex(function(t){return t.id===e.data.id});Number.isInteger(t)&&-1<t&&(NMNS.customerList.splice(t,1),c(!0))})),NMNS.socket.on("update customer",socketResponse("고객정보 수정",function(e){var t=NMNS.customerList.findIndex(function(t){return t.id===e.data.id});if(Number.isInteger(t)&&-1<t){var a=NMNS.customerList[t];a.name=$("#customerName").val(),a.contact=$("#customerContact").val(),a.etc=$("#customerEtc").val(),a.managerId=$("#customerManager").data("calendar-id");var s=NMNS.calendar.getCalendars();a.manager=s[s.findIndex(function(t){return t.id===a.managerId})],showSnackBar("<span>고객의 정보를 수정하였습니다.</span>"),c(!0)}},function(e){if("DUPLICATED"===e.data.reason){if(confirm("이미 같은 이름과 연락처를 가진 고객이 존재합니다.\n그 고객쪽으로 모든 정보 및 예약, 알림톡 내역을 합칠까요?"))return void NMNS.socket.emit("merge customer",{id:e.data.id,name:$("#customerName").val(),contact:$("#customerContact").val(),etc:$("#customerEtc").val(),managerId:$("#customerManager").data("calendar-id")})}else alert("고객정보 수정에 실패하였습니다."+(e.message?"("+e.message+")":""));var t=NMNS.customerList.findIndex(function(t){return t.id===e.data.id});Number.isInteger(t)&&-1<t&&($("#customerName").val(NMNS.customerList[t].name),$("#customerContact").val(NMNS.customerList[t].contact),$("#customerEtc").val(NMNS.customerList[t].etc))},!0)),NMNS.socket.on("get customer alrim",socketResponse("알림톡 내역 조회",function(t){o(t.data)})),NMNS.socket.on("delete customer",socketResponse("고객 삭제",function(t){NMNS.history.remove(t.data.id,function(t,e){return t.id===e})},function(e){var t=NMNS.history.find(function(t){return t.id===e.data.id});NMNS.history.remove(e.data.id,function(t,e){return t.id===e}),NMNS.customerList.splice(t.index,0,t),c(!0)})),NMNS.socket.on("merge customer",socketResponse("고객정보 합치기",function(){NMNS.socket.emit("get customer list",{type:"all",target:""===$("#customerSearchTarget").val()?void 0:$("#customerSearchTarget").val(),sort:$($(".customerSortType.active")[0]).data("action")}),showSnackBar("<span>두 고객의 정보와 예약, 알림톡 내역을 합쳤습니다.</span>"),$("#customerModal").modal("hide")},function(){NMNS.socket.emit("get customer list",{type:"all",target:""===$("#customerSearchTarget").val()?void 0:$("#customerSearchTarget").val(),sort:$($(".customerSortType.active")[0]).data("action")}),$("#customerModal").modal("hide")})),$("#customerModal").on("hidden.bs.modal",function(){if($(this).data("trigger")){$(this).removeData("trigger");var t=$(this).data("customer"),e=moment(new Date);e.hour()>=Number(NMNS.info.bizEndTime.substring(0,2))||e.hour()+1==Number(NMNS.info.bizEndTime.substring(0,2))&&e.minute()+30>Number(NMNS.info.bizEndTime.substring(2))?e=moment(NMNS.info.bizEndTime,"HHmm").subtract(30,"m"):e.hour()<Number(NMNS.info.bizBeginTime.substring(0,2))||e.hour()==Number(NMNS.info.bizBeginTime.substring(0,2))&&e.minute()<Number(NMNS.info.bizBeginTime.substring(2))?e=moment(NMNS.info.bizBeginTime,"HHmm"):e.minute(10*Math.ceil(e.minute()/10)),NMNS.calendar.openCreationPopup({title:t.name,start:e.toDate(),end:e.add(30,"m").toDate(),raw:{contact:t.contact,etc:t.etc},calendarId:t.managerId?t.managerId:void 0})}}).on("shown.bs.modal",function(){$("#customerName").focus()}),$("#customerContact, #customerAddContact").off("blur").on("blur",function(){filterNonNumericCharacter($(this))}),$("#submitCustomerAdd").on("touch click",function(t){if(t.preventDefault(),""!==$("#customerAddName").val()||""!==$("#customerAddContact").val()){var e={id:generateRandom(),name:$("#customerAddName").val(),contact:$("#customerAddContact").val(),etc:$("#customerAddEtc").val(),managerId:$("#customerAddManager").data("calendar-id")};NMNS.socket.emit("add customer",e),NMNS.customerList.splice(0,0,e),c(!0)}else alert("고객 이름과 전화번호 중 하나는 반드시 입력해주세요.")}),$("#submitCustomer").on("touch click",function(t){t.preventDefault();var e=$("#customerModal").data("customer");if(e){if(""===$("#customerName").val()&&""===$("#customerContact").val())return void alert("고객 이름과 전화번호 중 하나는 반드시 입력해주세요.");NMNS.socket.emit("update customer",{id:e.id,name:$("#customerName").val(),contact:$("#customerContact").val(),etc:$("#customerEtc").val(),managerId:$("#customerManager").data("calendar-id")})}else alert("알 수 없는 오류입니다. 새로고침 후 다시 시도해주세요.")}),$(".customerSortType").off("touch click").on("touch click",function(t){if($(this).hasClass("active"))NMNS.customerList.reverse();else{var e=t.target.getAttribute("data-action");e||(e=t.target.parentElement.getAttribute("data-action")),NMNS.customerList.sort(function a(t){switch(t){case"sort-date":return function(t,e){return t.history&&0!==t.history.length?e.history&&0!==e.history.length?t.history[0].date<e.history[0].date?1:t.history[0].date>e.history[0].date?-1:a("sort-name")(t,e):-1:e.history&&0<e.history.length?1:a("sort-name")(t,e)};case"sort-manager":return function(t,e){return t.manager?e.manager?t.manager.name<e.manager.name?-1:t.manager.name>e.manager.name?1:a("sort-name")(t,e):-1:e.manager?1:a("sort-name")(t,e)};case"sort-sales":return function(t,e){return t.sales?e.sales?1*t.sales<1*e.sales?-1:1*t.sales>1*e.sales?1:a("sort-name")(t,e):-1:e.sales?1:a("sort-name")(t,e)};case"sort-membership":return function(t,e){return t.membership?e.membership?1*t.membership<1*e.membership?-1:1*t.membership>1*e.membership?1:a("sort-name")(t,e):-1:e.membership?1:a("sort-name")(t,e)};case"sort-visit":return function(t,e){return t.history&&0!==t.history.length?e.history&&0!==e.history.length?t.history.length<e.history.length?-1:t.history.length>e.history.length?1:a("sort-name")(t,e):-1:e.history&&0<e.history.length?1:a("sort-name")(t,e)};case"sort-name":default:return function(t,e){return t.name?e.name?t.name<e.name?-1:t.name>e.name?1:0:-1:e.name?1:0}}}(e)),a=e,$(".customerSortType").removeClass("active"),$(".customerSortType[data-action='"+a+"']").addClass("active")}var a;c(!(i=0))}),$("#searchCustomer").on("keyup",function(t){13===t.which&&NMNS.socket.emit("get customer list",{type:"all",target:this.value,sort:$($(".customerSortType.active")[0]).data("action")})}),$("#addCustomerBtn").on("touch click",function(t){t.preventDefault(),$(".customerMenu").is(":visible")||$("#sidebarContainer .menuLink[data-link='customerMenu']").trigger("click"),$("#customerModal").modal("show");var e=$("#customerAddName");e.focus();var a=$("#customerAddNameIcon"),s=6,o=setInterval(function(){0<s?(e.toggleClass("blink"),a.toggleClass("blink"),s--):clearInterval(o)},150)});var t=!1;$(document).on("scroll",debounce(function(){$("#mainCustomerList").is(":visible")&&!t&&NMNS.customerList&&i<NMNS.customerList.length&&Math.max(document.body.scrollHeight-window.innerHeight-window.scrollY,0)<Math.max(100,.2*window.innerHeight)&&(t=!0,$("#mainCustomerLoading").show(),c(),$("#mainCustomerLoading").hide(),t=!1)},100))}();